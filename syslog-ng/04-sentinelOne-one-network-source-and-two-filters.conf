# This configuration file is designed for syslog-ng to process and forward logs 
# from a UDP source to a SentinelOne HTTP Event Collector (HEC) destination. 
# It defines a network source to receive logs, applies a filter to exclude 
# specific ICMP traffic logs based on predefined criteria, and sends the 
# remaining logs to the SentinelOne HEC endpoint.
#
# 1. Source for Check Point firewall logs via UDP
source udp_checkpoint {
  network(
    transport("udp")
    port(514)
    flags(no-parse)
  );
};

# The filter section (f_redact_checkpoint_icmp_implied) specifically excludes 
# ICMP traffic logs that match the following conditions:
# - Protocol is ICMP (proto:"1").
# - ICMP type is "8" (echo request).
# - Action is "Accept".
# - Rule name is "Implied Rule".
# - Destination is either "8.8.8.8" or "8.8.4.4".
# This ensures those logs are not forwarded to the destination.
#
# 2. Redaction Filter: ICMP Echo Requests to public DNS via implied rule
filter f_redact_checkpoint_icmp_implied {
  message("proto:\"1\"") and
  message("icmp_type:\"8\"") and
  message("action:\"Accept\"") and
  message("rule_name:\"Implied Rule") and (
    message("dst:\"8.8.8.8\"") or
    message("dst:\"8.8.4.4\"")
  );
};

# 3. Redaction Filter: Accepted NTP (UDP port 123)
filter f_redact_checkpoint_ntp {
  message("proto:\"17\"") and
  message("dport:\"123\"") and
  message("action:\"Accept\"");
};

# 4. Combined redaction filter
filter f_redact_combined {
  f_redact_checkpoint_icmp_implied or f_redact_checkpoint_ntp;
};

# 5. Destination: Redacted ICMP logs (optional auditing)
destination d_redacted_icmp_logs {
  file("/var/log/syslog-ng/redacted_icmp_checkpoint.log");
};

# 6. Destination: Redacted NTP logs (optional auditing)
destination d_redacted_ntp_logs {
  file("/var/log/syslog-ng/redacted_ntp_checkpoint.log");
};

# 7. Destination: Main outbound HTTP endpoint with disk buffer
destination d_sentinelone_hec_checkpoint {
  http(
    url("https://ingest.us1.sentinelone.net/services/collector/raw?sourcetype=marketplace-checkpointfirewall-1.0.1")
    headers("Authorization: Bearer $SDL_TOKEN", "Content-Type: text/plain")
    body("${MESSAGE}")
    method("POST")
    content-compression("gzip")
    batch-lines(5000)
    batch-bytes(6000000)
    batch-timeout(10000)
    retries(3)
    workers(4)
    disk-buffer(
      mem-buf-size(64M)
      disk-buf-size(2G)
      reliable(yes)
      dir("/var/log/syslog-ng/disk-buffer/checkpoint")
    )
  );
};

# 8. Log path: Deliver all logs except those filtered out
log {
  source(udp_checkpoint);
  filter(not f_redact_combined);
  destination(d_sentinelone_hec_checkpoint);
};
